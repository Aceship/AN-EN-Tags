<!DOCTYPE html>

<html lang="zh-Hans" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="theme-color" content="#222222ff">
    <title translate-id="web-title">Arknights Recruitment Calculator</title>
    <link rel="manifest" href="./manifest.json" crossorigin="use-credentials">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/ak.css">
    <script src="js/multilingual.js"></script>
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    <script src="js/jquery-3.4.0.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-138420636-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'UA-138420636-1');
    </script>
</head>
<body>
    <!-- <button class="btn btn-sm btn-primary goToTag" style="position:fixed;bottom:15px ;right: 0px;size:70px 70px;padding: 10px;z-index: 10000" id="to-tag" type="button">^ </button> -->
    <nav class="navbar fixed-top navbar-expand-md navbar-dark bg-dark" style="background-image: linear-gradient(#222222ff 70%,#222222ff , #111111aa );">
            <img src="./img/factions/logo_rhodes.png" width="40" height="40" style="transform:scale(1.2,1.2)translate(-8px,1px)"class="d-inline-block align-top" alt="">
        <a class="navbar-brand" href="#" translate-id="topbar-1">Arknights Toolbox</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="展开">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-between" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="akhr.html" translate-id="topbar-2">Recruitment Calculator</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="akhrchars.html" translate-id="topbar-3">Operators Table</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="aklevel.html" translate-id="topbar-4">Leveling Calculator</a>
                </li>
                <li class="nav-item">
                        <a class="nav-link" href="akguide.html" translate-id="topbar-5">Guide</a>
                </li>
                <li class="nav-item active">
                    <a class="nav-link" href="akevolve.html" translate-id="topbar-6">Material Calculator</a>
                </li>
            </ul>
            <ul class="navbar-nav ml-auto">

                <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" style="display:inline-flex;padding-left:25px;"href="#" id="regionDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" >
                                <div class="ak-subtitle ak-disable" translate-id="language-1">Server</div>
                                <div class="ak-disable" id="display-reg">CN</div>
                        </a>
                        
                        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item reg unselectable" onclick="regDropdown($(this))" value="cn">Chinese</a>
                        </div>
                    </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" style="display:inline-flex;padding-left:25px"href="#" id="languageDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                            <div class="ak-subtitle ak-disable" translate-id="language-2">Language</div>
                            <div class="ak-disable" id="display-lang">English</div>
                    </a>
                    <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                        <a class="dropdown-item lang unselectable" onclick="langDropdown($(this))" value="en">English</a>
                        <a class="dropdown-item lang unselectable" onclick="langDropdown($(this))" value="cn">Chinese</a>
                        <a class="dropdown-item lang unselectable" onclick="langDropdown($(this))" value="jp">Japanese</a>
                    </div>
                </li>
            </ul>
        </div>
    </nav>
    <div style="padding-bottom:50px"></div>

    <button class="btn btn-sm ak-ontop-button" style="position:fixed;bottom:60px ;right: 0px;size:70px 70px;padding: 4px;z-index: 10000" id="btn-filter" type="button">Filter </button>
    <button class="btn btn-sm ak-ontop-button" style="position:fixed;bottom:20px ;right: 0px;size:70px 70px;padding: 4px;z-index: 10000" id="btn-reset" type="button">Reset </button>
    <!-- <button class="btn btn-sm btn-primary ak-ontop-button" style="position:fixed;bottom:100px ;right: 0px;size:70px 70px;padding: 2px;z-index: 10000" id="btn-load" type="button">Filter </button> -->
    <div class="container " style="margin:auto;max-width:1000px;padding:0">
        <div class="d-inline d-sm-none " id="mobile-only-visible"></div>
        <div class="col-12 alert alert-dark mt-3 p-1 p-sm-2 ak-c-black" role="alert">
            <button type="button" class="btn btn-sm btn-success my-1" id="btn-filter">
                <!-- <span class="cn">过滤</span> -->
                <span class="en">Filter</span>
            </button>
            <button type="button" class="btn btn-sm btn-secondary btn-opt my-1" opt-id="all" id="opt-all">ALL</button>
            <button type="button" class="btn btn-sm btn-primary btn-opt my-1" opt-id="5">5★</button>
            <button type="button" class="btn btn-sm btn-primary btn-opt my-1" opt-id="4">4★</button>
            <button type="button" class="btn btn-sm btn-primary btn-opt my-1" opt-id="3">3★</button>
            <button type="button" class="btn btn-sm btn-primary btn-opt my-1" opt-id="2">2★</button>
            <button type="button" class="btn btn-sm btn-secondary btn-opt my-1" opt-id="1">1★</button>
            <button type="button" class="btn btn-sm btn-danger my-1" id="btn-reset">
                <!-- <span class="cn">重置</span> -->
                <span class="en">Reset</span>
            </button>
            <button type="button" class="btn btn-sm btn-warning my-1" id="btn-load">
                <!-- <span class="cn">加载已保存数据</span> -->
                <span class="en">Load saved data</span>
            </button>
            <hr class="my-1" />
            <!-- <p class="cn my-0"><small><a class="save" href="?n&h&o">右键或长按复制我，保存输入信息</a></small></p> -->
            <p class="en my-0"><small><a class="save" href="?n&h&o">Copy me with right click or long press, to save your input</a></small></p>
        </div>
        <div class="col-12 mt-3 p-1 p-sm-2">
            <div class="d-flex flex-wrap" id="row-m">
            </div>
        </div>
        <hr />
        <div class="row col-12 ak-mid ak-shadow">
            <!-- <div class="col-12 text-left cn">
                <p><b>使用说明</b></p>
                <p>1. 输入需要的材料数量；</p>
                <p>2. 点击“过滤”掉与合成无关的材料；</p>
                <p>3. 输入已有的材料数量；</p>
                <p>4. 再次“过滤”掉不需要刷的材料。</p>
            </div> -->
            <div class="col-12 text-left en">
                <p><b>Usage</b></p>
                <p>1. Input the needed number of materials.</p>
                <p>2. "Filter" out irrelevant materials.</p>
                <p>3. Input material numbers you have.</p>
                <p>4. "Filter" out materials you don't need to work for.</p>
            </div>
        </div>
        <!-- <div class="col-12 alert alert-success mt-1 cn" role="alert">
            如需Excel版，可以使用<a href="https://bbs.nga.cn/read.php?tid=17155811">材料合成计算器</a>。
        </div> -->
    </div>

    <hr />
    <div class="row col-12 ak-footer">
        <div class="col-12 text-center">
            <p>Forked from <a href = "https://graueneko.github.io/akhr.html">grauneko web</a></p>
        <div class="col-12 text-center"></div>
            <p>Last update: 12 May 2019, <a href="https://github.com/Aceship/AN-EN-Tags/issues">Contact</a></p>
            <p>
                Data source:
                <a href="http://wiki.joyme.com/arknights/%E5%B9%B2%E5%91%98%E6%95%B0%E6%8D%AE%E8%A1%A8">Arknights Wiki (CN)</a>
            </p>
            <p>Powered by GraueNeko, Aceship, Faryzal2020</p>
        </div>
    </div>
    <script> 
            
            showCurrentLang();
            //let lang = getLang();
            let lang;
            let reg;
            if(typeof localStorage.gameRegion === "undefined" || localStorage.gameRegion == ""|| localStorage.webLang == ""){
                console.log("game region undefined");
                localStorage.setItem("gameRegion", 'cn');
                localStorage.setItem("webLang", 'en');
                reg = "cn";
                lang = "en";
            } else {
                reg = localStorage.gameRegion;
                lang = localStorage.webLang;
            }
            $('.reg[value='+reg+']').addClass('selected');
            $('.lang[value='+lang+']').addClass('selected');

            $('#display-reg').text(reg.toUpperCase())
            
            switch (lang) {
                case "en":$('#display-lang').text("English");break;
                case "cn":$('#display-lang').text("Chinese");break;
                case "jp":$('#display-lang').text("Japanese");break;
            }

            function regDropdown(el){
                localStorage.gameRegion = el.attr("value");
                $(".dropdown-item.reg").removeClass("selected");
                el.addClass("selected");   
                changeUILanguage();
            }
                        
            function langDropdown(el){
                localStorage.webLang = el.attr("value");
                $(".dropdown-item.lang").removeClass("selected");
                el.addClass("selected");
                changeUILanguage();
            }
            document.title = { 'cn': '明日方舟精英化材料计算器', 'en': 'Arknights Evolve Cost Calculator' }[lang];
            let ms = {};
            let mByLvl = [[], [], [], [], []];
            let ismobile = $('#mobile-only-visible').is(':visible');
            loadMaterials();
            
            function refresh(){
                ms = {};
                mByLvl = [[], [], [], [], []];
                $("#row-m").html("");
            }

            function loadMaterials(){
                refresh();
                $.getJSON("akmaterial.json", (data) => {
                    $.each(data, (_, v) => {
                        ms[v['name_cn']] = v;
                        mByLvl[v['level'] - 1].push(v['name_cn']);
                    });
                    let minShowLevel = 2;
                    let colors = ['1', '2', '3', '4', '5']
                    for (let i = 5; i > 0; i--) {
                        $.each(mByLvl[i - 1], (_, n) => {
                            let srcHtml = [];
                            let cardid = ms[n]['id'];
                            
                            
                            $.each(ms[n].source, (k, v) => { 
                                let stageCol = "#555";
                                switch (v) {
                                    case "Always"   : stageCol = "#090" ;break;
                                    case "Common"   : stageCol = "#990";break;
                                    case "Medium"   : stageCol = "#950";break;
                                    case "Rare"     : stageCol = "#930";break;
                                    case "Very Rare": stageCol = "#900";break;
                                }
                                srcHtml.push('<small class="ak-sm-text"> <span class="ak-sm ak-back"style="background:'+stageCol+';color:#000"></span>' + k + '<span class="ak-sm ak-back">'+v+'</span>'+"</small>") 
                            });

                            let isOnStage = "";
                            if(srcHtml!=""){
                                isOnStage = ""
                                +     '<div class="card-body p-1 ak-c-black" style="padding:0px">'  
                                +         '<a class="ak-subtitle2">Drop location :</a>'                  
                                +         srcHtml.join("<br />")
                                +     '</div>'
                            }else{
                                isOnStage = ""
                                +     '<div class="card-body p-1 ak-c-black" style="padding:0px">'  
                                +         '<a class="ak-subtitle2">Only Craftable</a>'                  
                                +         srcHtml.join("<br />")
                                +     '</div>'
                            }
                            console.log("lang: "+lang);
                            $("#row-m").append(
                                     '<div class="ak-card-group m-1 lvl-' + ms[n]['level'] + '"style=" ' + (i < minShowLevel ? 'display:none' : '')+ ';padding:0;">'
                                    +   '<div class="ak-card-container card ak-shadow-small ak-rare-bg' + '" style="border:transparent;padding:0px;z-index:1;">'
                                    +     '<div class="ak-title ak-shadow-small" style="z-index:5;display:inline-block;white-space: nowrap;">'+eval('ms[n].name_'+lang)+'</div>'  
                                    +         '<img class="card-img-bg" style=";z-index:3;position:absolute" src="img/material/bg/item-'+ i + '.png">'
                                    +         '<div class="ak-img-container" style="vertical-align:middle;padding-left:0px;margin:0px">'  
                                    +             '<img class="card-img-top col-12" style="z-index:4;display: block;" src="img/material/'+ ms[n]['id'] + '.png">'
                                    +         '</div>'       
                                    + isOnStage
                                    +   '</div>'
                                    +   '<div class="ak-rare-' + colors[i - 1] +'" style="width:2px;margin:0px;padding:0;z-index:0"></div>'
                                    +       '<div class="card p-0 ak-back ak-btn" style="max-width:72px;margin:0px">'
                                    +           '<div class="card-body p-1  style="padding:0px;margin:0px">'
                                    +           '<form style="">'
                                    +               '<div class="form-group mb-0">'
                                    +                   '<input type="text" class="form-control form-control-sm mt-1 in-mc   ak-mid" style="padding:0;text-align:center" placeholder=" ' + { 'cn': '需要', 'en': 'Need' }[lang] + '" id="need-' + cardid + '"/>'
                                    +                   '<input type="text" class="form-control form-control-sm mt-1 in-mc   ak-mid" style="padding:0;text-align:center" placeholder=" ' + { 'cn': '已有', 'en': 'Have' }[lang] + '" id="have-' + cardid + '"/>'
                                    +                   '<input type="text" class="form-control form-control-sm mt-1 in-lack ak-mid" style="padding:0;text-align:center;background:#222;border:transparent;color:#fff" placeholder=" ' + { 'cn': '仍需', 'en': 'Lack' }[lang] + '" id="lack-' + cardid + '" disabled/>'
                                    +               '</div>'
                                    +           '</form>'
                                    +       '</div>'
                                    +   '</div>'
                                    );
                            // if (!ismobile)
                               
                            // else
                            //     $("#row-m").append('<div class="card col-4 my-1 p-0 lvl-' + ms[n]['level'] + ' border-' + colors[i - 1]
                            //         + '" ' + (i < minShowLevel ? 'style="display:none;"' : '')
                            //         + '><img class="card-img-top" style="max-width:70px;margin:auto;" src="img/material/'
                            //         + ms[n]['id'] + '.png"><div class="card-body p-1 p-md-2">'
                            //         + n + '<br />'
                            //         + srcHtml.join("<br />")
                            //         + '<form><div class="form-group mb-0">'
                            //         + '<input type="text" class="form-control form-control-sm mt-1 in-mc" placeholder="' + { 'cn': '需要', 'en': 'Need' }[lang] + '" id="need-' + cardid + '"/>'
                            //         + '<input type="text" class="form-control form-control-sm mt-1 in-mc" placeholder="' + { 'cn': '已有', 'en': 'Have' }[lang] + '" id="have-' + cardid + '"/>'
                            //         + '<input type="text" class="form-control form-control-sm mt-1 in-lack" placeholder="' + { 'cn': '仍需', 'en': 'Lack' }[lang] + '" id="lack-' + cardid + '" disabled/>'
                            //         + '</div></form>'
                            //         + '</div></div>');
                        });
                        $("#row-m").append('<div class="w-100 my-1" />');
                    }
                });
            }

            let allns = []; let allhs = []; let allos = [];
            function genUrl() {
                allos = [];
                for (let i = 1; i <= 5; i++) {
                    if ($(".btn-opt[opt-id='" + i + "']").hasClass("btn-primary")) allos.push(i);
                }
                $(".save").attr("href", "?n=" + allns.join("+") + "&h=" + allhs.join("+") + "&o=" + allos.join("+"));
            }

            function changeUILanguage(){
                reg = $('.reg.selected').attr("value");
                lang =$('.lang.selected').attr("value");
                console.log("reg: "+reg);
                console.log("lang: "+lang);
                $('#display-reg').text(reg.toUpperCase())
                
                switch (lang) {
                    case "en":$('#display-lang').text("English");break;
                    case "cn":$('#display-lang').text("Chinese");break;
                    case "jp":$('#display-lang').text("Japanese");break;
                }
                loadMaterials();
            }

            function calc() {
                
                let counts = {};
                $.each(ms, (n, m) => {
                    let need = parseInt($("#need-" + m['id']).val());
                    if (isNaN(need)) need = 0;
                    let have = parseInt($("#have-" + m['id']).val());
                    if (isNaN(have)) have = 0;
                    let diff = need - have;
                    counts[n] = {
                        'need': need,
                        'have': have,
                        'upper': 0,
                        'compose': 0,
                        'lack': diff > 0 ? diff : 0
                    }
                });
                for (let i = 4; i >= 0; i--) {
                    $.each(mByLvl[i], (_, n) => {
                        $.each(ms[n].madeof, (mon, moc) => {
                            counts[mon].upper += moc * counts[n].lack;
                            let diff = counts[mon].need + counts[mon].upper - counts[mon].have;
                            counts[mon].lack = diff > 0 ? diff : 0;
                        });
                    });
                }
                for (let i = 1; i < 5; i++) {
                    $.each(mByLvl[i], (_, n) => {
                        let m = ms[n];
                        if (counts[n].lack === 0) return;
                        let maxCompose = $.isEmptyObject(m['madeof']) ? 0 : Number.MAX_SAFE_INTEGER;
                        $.each(m['madeof'], (man, mac) => {
                            let cm = counts[man];
                            if (cm.have / mac < maxCompose) {
                                maxCompose = cm.have / mac;
                            }
                        });
                        maxCompose = Math.floor(maxCompose > counts[n].lack ? counts[n].lack : maxCompose);
                        if (maxCompose > 0) {
                            $.each(m['madeof'], (man, mac) => {
                                counts[man].have -= maxCompose * mac;
                            });
                            console.log(n + maxCompose);
                            counts[n].have += maxCompose;
                            counts[n].lack = counts[n].need + counts[n].upper > counts[n].have ? counts[n].need + counts[n].upper - counts[n].have : 0;
                        }
                    });
                }
                allns = []; allhs = [];
                $.each(ms, (n, m) => {
                    $("#lack-" + m['id']).val(counts[n]['lack']);
                })
                $.each(ms, (_, m) => {
                    allns.push(counts[m.name].need);
                    allhs.push(counts[m.name].have);
                });
                $(".in-lack").each(function() {
                if($(this).val() >= 1){
                        $(this).css('background-color','#300');
                    }else{
                        $(this).css('background-color','#222');
                    }
                })
                genUrl();
            }
            $(document).on('change input paste', '.in-mc', calc);
            $(document).on("click", ".btn-opt", function () {
                $(this).toggleClass("btn-primary btn-secondary");
                let checked = $(this).hasClass("btn-primary");
                if (checked) $(".lvl-" + $(this).attr("opt-id")).show();
                else $(".lvl-" + $(this).attr("opt-id")).hide();
                if ($(this).attr("id") === "opt-all") {
                    $(".btn-opt").removeClass("btn-primary btn-secondary").addClass(
                        checked ? "btn-primary" : "btn-secondary"
                    );
                    for (let i = 1; i <= 5; i++) {
                        if (checked) $(".lvl-" + i).show();
                        else $(".lvl-" + i).hide();
                    }
                } else {
                    if ($("#opt-all").hasClass("btn-primary")) {
                        $("#opt-all").toggleClass("btn-primary btn-secondary");
                    } else {
                        let checkedCount = 0;
                        $(".btn-opt").each(function (_, __) {
                            if ($(this).attr("id") === "opt-all") return;
                            if ($(this).hasClass("btn-primary")) checkedCount++;
                        });
                        if (checkedCount === 5) $("#opt-all").toggleClass("btn-primary btn-secondary");
                    }
                }
                genUrl();
            });

            let togglefilter = false ;
            $(document).on("click", "#btn-filter", () => {
                // if (ismobile)
                //     $(".card").each((_, e) => {
                //         let v = parseInt($(e).find(".in-lack").val());
                //         if (isNaN(v) || v === 0) $(e).hide();
                //     });
                // else
                togglefilter = !togglefilter;
                if(togglefilter){
                    $(".ak-card-group").each((_, e) => {
                        let v = parseInt($(e).find(".in-lack").val());
                        if (isNaN(v) || v === 0) $(e).hide();
                    });
                }else{
                    $(".ak-card-group").each((_, e) => {
                        let v = parseInt($(e).find(".in-lack").val());
                        if (isNaN(v) || v === 0) $(e).show();
                    });
                }
            });
            $(document).on("click", "#btn-reset", () => {
                $(".btn-option").removeClass("btn-primary btn-secondary").addClass("btn-primary");
                $(".in-mc, .in-lack").val("");
                $(".in-lack").each(function() {
                        $(this).css('background-color','#222');
                })
                // if (ismobile)
                //     $(".card").show();
                // else
                    $(".ak-card-group").show();
            })
            let savedNeed = urlParam("n", "");
            let savedHave = urlParam("h", "");
            let savedOption = urlParam("o", "").split("+");
            if (!(savedHave === "" || savedNeed === "" || savedOption === "")) {
                $("#btn-load").show();
            } else {
                $("#btn-load").hide();
            }

            $(document).on("click", "#btn-load", () => {
                let needs = savedNeed.split("+");
                let haves = savedHave.split("+");
                for (let i = 0; i < needs.length; i++) {
                    $("#need-" + i).val(needs[i]);
                }
                for (let i = 0; i < haves.length; i++) {
                    $("#have-" + i).val(haves[i]);
                }
                $(".btn-opt").removeClass("btn-primary btn-secondary");
                for (let i = 1; i <= 5; i++) {
                    if (savedOption.includes(i.toString())) {
                        $(".btn-opt[opt-id='" + i + "']").addClass("btn-primary");
                        $(".lvl-" + i).show();
                    } else {
                        $(".btn-opt[opt-id='" + i + "']").addClass("btn-secondary");
                        $(".lvl-" + i).hide();
                    }
                }
                $("#opt-all").addClass(savedOption.length === 5 ? "btn-primary" : "btn-secondary");
                calc();
            });
    </script>
</body>
</html>