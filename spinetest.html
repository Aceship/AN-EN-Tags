<html>

<head>
    <script src="js/spine-widget.js"></script>
    <script src="js/spine-skeleton-binary.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js'></script>
</head>

<body style="background-color: rgb(80, 80, 80);">
    <center>
        <div id="spine-text" style="color: white;"></div>

        <div id="spine-frame">
            <div id="spine-widget" style="margin-bottom: 20px; width: 600px; height: 600px;"></div>
            <div id="spine-bg" style="margin-bottom: 20px; width: 600px; height: 600px;"></div>
            <div id="spine-toolbar" style="margin-bottom: 20px; width: 600px; height: 600px;"></div>
        </div>
    </center>
    <script>
        var vars = getUrlVars()

        var chibitype = 'character'
        var charName = 'char_180_amgoat';
        var chibipers = 'front'
        var chibiName = 'char_180_amgoat'
        var folder = `./spineassets/${chibitype}/${charName}/${chibipers}/`

        console.log(vars)
        if(vars.has("folder")){
            folder = vars.get("folder")
        }
        if(vars.has("name")){
            chibiName = vars.get("name")
        }
        var defaultAnimationName = "Default";
        console.log(defaultAnimationName);
        console.log(folder)
        console.log(chibiName)
        $(document).ready(function(){
            
            if (chibiName != null && defaultAnimationName != null) {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', folder + chibiName + ".skel", true);
                xhr.responseType = 'arraybuffer';
                var array;
                $("#spine-widget").hide()
                xhr.onloadend = function (e) {
                    if (xhr.status != 404) {
                        buffer = xhr.response;
                        array = new Uint8Array(buffer);
                        // console.log(array);
                        skelBin = new SkeletonBinary();
                        skelBin.data = array;
                        skelBin.initJson();
                        // console.log(JSON.stringify(skelBin.json, null, "\t"));
                        new spine.SpineWidget("spine-widget", {
                            jsonContent: JSON.stringify(skelBin.json),
                            atlas: folder + chibiName + ".atlas",
                            animation: defaultAnimationName,
                            backgroundColor: "#00000000",
                            // debug: true,
                            // imagesPath: chibiName + ".png", 
                            premultipliedAlpha: true,
                            fitToCanvas : true,
                            loop:true,
                            // x:220,
                            // y:100,
                            
                            scale:0.6,
                            success: function (widget) {
                                var animIndex = 0;
                                $("#spine-text").text(widget.skeleton.data.animations[0].name)
                                var animations = widget.skeleton.data.animations;
                                console.log(animations)
                                console.log(widget)
                                $("#spine-widget").fadeIn(200)
                                // setTimeout(function() {
                                // if(animations.find(search=>search.name=="Start")){
                                //     var starting = animations.map(function(e) { return e.name; }).indexOf('Start')
                                //     var idle = animations.map(function(e) { return e.name; }).indexOf('Idle')
                                //     widget.setAnimation(animations[starting].name)
                                //     $("#spine-widget").fadeIn(200)
                                //     setTimeout(function() { widget.setAnimation(animations[idle].name) }, animations[starting].duration*1000-20);
                                // }},1000);
                                // widget.stage.clearTracks()
                                widget.state.setAnimation(0,"Start")
                                widget.state.addAnimation(1,"Idle",true,animations[GetAnimationIndex(animations,'Start')].duration)

                                //attack 5 times loop and then do nothing

                                // var delay = 0
                                // widget.state.setAnimation(0,"Attack_Begin")
                                // delay +=animations[GetAnimationIndex(animations,'Attack_Begin')].duration
                                // widget.state.addAnimation(1,"Attack_Loop",true,delay)
                                // delay += animations[GetAnimationIndex(animations,'Attack_Loop')].duration*5
                                // widget.state.addAnimation(2,"Attack_End",true,delay)
                                // delay += animations[GetAnimationIndex(animations,'Attack_End')].duration
                                // widget.state.addAnimation(3,"Idle",true,delay)
                                // widget.setAnimation("Skill_2_Begin")

                                // skill 2 5 times
                                // var delay = 0
                                // widget.state.clearTracks()
                                // widget.state.setAnimation(0,"Skill_2_Begin")
                                // delay +=animations[GetAnimationIndex(animations,'Skill_2_Begin')].duration
                                // widget.state.addAnimation(1,"Skill_2_Loop",true,delay)
                                // delay += animations[GetAnimationIndex(animations,'Skill_2_Loop')].duration*5
                                // widget.state.addAnimation(2,"Skill_2_End",true,delay)
                                // delay += animations[GetAnimationIndex(animations,'Skill_2_End')].duration
                                // widget.state.addAnimation(3,"Idle",true,delay)

                                // widget.state.trackEntry(3,"Idle",true,"Attack_Begin")
                                console.log(widget.state)
                                console.log(widget.state.trackEntry)
                                widget.canvas.onclick = function () {
                                    widget.state.clearTracks()
                                    animIndex++;
                                    
                                    // console.log(animations)
                                    if (animIndex >= animations.length) animIndex = 0;
                                    widget.setAnimation(animations[animIndex].name)
                                    $("#spine-text").text(animations[animIndex].name)
                                }
                            }
                        })
                    }
                };
                xhr.send()
            }
        })

        function GetAnimationIndex(anim,name){
            return anim.map(function(e) { return e.name; }).indexOf(name)
        }
        function getUrlVars() {
            return new URL(window.location.href).searchParams;
        }
    </script>
</body>

</html>