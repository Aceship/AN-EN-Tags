<html>

<head>
    <link rel='stylesheet' href='css/ak.css'>
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css'>
    <script src="js/spine-widget.js"></script>
    <script src="js/spine-skeleton-binary.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js'></script>
</head>

<body style="background-color: rgb(80, 80, 80);">
    <center>
        

        <div id="spine-frame" style="position: relative;width: 300px; height: 300px">
            <div id="spine-widget" style="position:absolute;width: 400px; height: 400px;top:-80px;left:-50px"></div>
            <div id="spine-bg" style="position:absolute"></div>
            <div id="spine-toolbar" style="position:absolute;bottom:-20px;width:300px;height:70px">
                <button class='col-3 btn btn-sm ' style='margin-top:10px;padding: 5px 5px' onclick='ChangeAnimation(-1)' type='button' id='opBrowseButton2'>Previous</button>
                <button class='col-3 btn btn-sm ' style='margin-top:10px;padding: 5px 5px' onclick='ChangeAnimation(1)' type='button' id='opBrowseButton2'>Next</button>
            </div>
            <div id="spine-text" style="color: white;"></div>
        </div>
    </center>
    <script>
        var vars = getUrlVars()

        var chibitype = 'character'
        var charName = 'char_180_amgoat';
        var chibipers = 'front'
        var chibiName = 'char_180_amgoat'
        var folder = `./spineassets/${chibitype}/${charName}/${chibipers}/`
        var spinewidget 
        var animIndex = 0;
        var animations
        var animationqueue

        console.log(vars)
        if(vars.has("folder")){
            folder = vars.get("folder")
        }
        if(vars.has("name")){
            chibiName = vars.get("name")
        }
        var defaultAnimationName = "Default";
        console.log(defaultAnimationName);
        console.log(folder)
        console.log(chibiName)
        $(document).ready(function(){
            
            if (chibiName != null && defaultAnimationName != null) {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', folder + chibiName + ".skel", true);
                xhr.responseType = 'arraybuffer';
                var array;
                $("#spine-widget").hide()
                xhr.onloadend = function (e) {
                    if (xhr.status != 404) {
                        buffer = xhr.response;
                        array = new Uint8Array(buffer);
                        // console.log(array);
                        skelBin = new SkeletonBinary();
                        skelBin.data = array;
                        skelBin.initJson();
                        // console.log(JSON.stringify(skelBin.json, null, "\t"));
                        new spine.SpineWidget("spine-widget", {
                            jsonContent: JSON.stringify(skelBin.json),
                            atlas: folder + chibiName + ".atlas",
                            animation: defaultAnimationName,
                            backgroundColor: "#00000000",
                            // debug: true,
                            // imagesPath: chibiName + ".png", 
                            premultipliedAlpha: true,
                            fitToCanvas : false,
                            loop:true,
                            x:200,
                            y:100,
                            
                            scale:0.35,
                            success: function (widget) {
                                
                                spinewidget = widget
                                $("#spine-text").text(widget.skeleton.data.animations[0].name)
                                animations = widget.skeleton.data.animations;
                                console.log(animations)
                                console.log(widget)
                                $("#spine-widget").fadeIn(200)
                                // setTimeout(function() {
                                // if(animations.find(search=>search.name=="Start")){
                                //     var starting = animations.map(function(e) { return e.name; }).indexOf('Start')
                                //     var idle = animations.map(function(e) { return e.name; }).indexOf('Idle')
                                //     widget.setAnimation(animations[starting].name)
                                //     $("#spine-widget").fadeIn(200)
                                //     setTimeout(function() { widget.setAnimation(animations[idle].name) }, animations[starting].duration*1000-20);
                                // }},1000);
                                // widget.stage.clearTracks()
                                if(animations.find(search=>search.name=="Start")){
                                    CreateAnimation(["Start","Idle"])
                                }else if(animations.find(search=>search.name=="Relax")){
                                    CreateAnimation("Relax")
                                }

                                CheckAnimationSet(animations)
                                //attack 5 times loop and then do nothing

                                // var delay = 0
                                // widget.state.setAnimation(0,"Attack_Begin")
                                // delay +=animations[GetAnimationIndex(animations,'Attack_Begin')].duration
                                // widget.state.addAnimation(1,"Attack_Loop",true,delay)
                                // delay += animations[GetAnimationIndex(animations,'Attack_Loop')].duration*5
                                // widget.state.addAnimation(2,"Attack_End",true,delay)
                                // delay += animations[GetAnimationIndex(animations,'Attack_End')].duration
                                // widget.state.addAnimation(3,"Idle",true,delay)

                                // //auto repeat the same thing
                                // var totaldelay = delay 

                                // setInterval(function(){
                                //     var delay = 0
                                //     widget.state.clearTracks()
                                //     widget.state.setAnimation(0,"Attack_Begin")
                                //     delay +=animations[GetAnimationIndex(animations,'Attack_Begin')].duration
                                //     widget.state.addAnimation(1,"Attack_Loop",true,delay)
                                //     delay += animations[GetAnimationIndex(animations,'Attack_Loop')].duration*5
                                //     widget.state.addAnimation(2,"Attack_End",true,delay)
                                //     delay += animations[GetAnimationIndex(animations,'Attack_End')].duration
                                //     widget.state.addAnimation(3,"Idle",true,delay)
                                // }, (totaldelay+animations[GetAnimationIndex(animations,'Idle')].duration)*1000);
                                

                                // skill 2 5 times
                                // var delay = 0
                                // widget.state.clearTracks()
                                // widget.state.setAnimation(0,"Skill_2_Begin")
                                // delay +=animations[GetAnimationIndex(animations,'Skill_2_Begin')].duration
                                // widget.state.addAnimation(1,"Skill_2_Loop",true,delay)
                                // delay += animations[GetAnimationIndex(animations,'Skill_2_Loop')].duration*5
                                // widget.state.addAnimation(2,"Skill_2_End",true,delay)
                                // delay += animations[GetAnimationIndex(animations,'Skill_2_End')].duration
                                // widget.state.addAnimation(3,"Idle",true,delay)

                                // // auto repeat the same thing
                                // var totaldelay = delay 

                                // animationqueue = setInterval(function(){
                                //     var delay = 0
                                //     widget.state.clearTracks()
                                //     widget.state.setAnimation(0,"Skill_2_Begin")
                                //     delay +=animations[GetAnimationIndex(animations,'Skill_2_Begin')].duration
                                //     widget.state.addAnimation(1,"Skill_2_Loop",true,delay)
                                //     delay += animations[GetAnimationIndex(animations,'Skill_2_Loop')].duration*5
                                //     widget.state.addAnimation(2,"Skill_2_End",true,delay)
                                //     delay += animations[GetAnimationIndex(animations,'Skill_2_End')].duration
                                //     widget.state.addAnimation(3,"Idle",true,delay)
                                // }, (totaldelay+animations[GetAnimationIndex(animations,'Idle')].duration)*1000);

                                // CreateAnimation(["Skill_2_Begin",["Skill_2_Loop",5],"Skill_2_Idle"],true,true)

                                //should've made function for this shit with array

                                // widget.state.trackEntry(3,"Idle",true,"Attack_Begin")
                                // console.log(widget.state)
                                // console.log(widget.state.trackEntry)
                                $("#spine-toolbar-next").onclick = function () {
                                    widget.state.clearTracks()
                                    if(animationqueue!=undefined)clearInterval(animationqueue)
                                    animIndex++;
                                    // console.log(animations)
                                    if (animIndex >= animations.length) animIndex = 0;
                                    widget.setAnimation(animations[animIndex].name)
                                    $("#spine-text").text(animations[animIndex].name)
                                }
                            }
                        })
                    }
                };
                xhr.send()
            }
            
        })
        function ChangeAnimation(num){
            spinewidget.state.clearTracks()
            // if(animationqueue!=undefined)clearInterval(animationqueue)
            animIndex += num;
            // console.log(animations)
            if (animIndex >= animations.length) animIndex = 0;
            else if (animIndex < 0) animIndex = animations.length-1;
            // spinewidget.state.setDefaultMix(0.1);
            // spinewidget.config.scale = 2
            console.log(spinewidget)
            console.log(animIndex)
            spinewidget.setAnimation(animations[animIndex].name)
            $("#spine-text").text(animations[animIndex].name)
        }


        function CreateAnimation(animArray,endloop = false,skipStart = false){
            if(Array.isArray(animArray)||(Array.isArray(animArray)&&animArray.length!=1)){
                var delay = 0
                var animNum = 0
                if(animationqueue!=undefined)clearInterval(animationqueue)
                spinewidget.state.clearTracks()
                animArray.forEach(element => {
                    var curranim = element
                    var animTimes = 1
                    if(Array.isArray(element)){
                        curranim = element[0]
                        animTimes = element[1]
                    }
                    if(animNum==0)spinewidget.state.setAnimation(0,curranim)
                    else spinewidget.state.addAnimation(animNum,curranim,true,delay)
                    delay +=animations[GetAnimationIndex(animations,curranim)].duration*animTimes
                    animNum++
                    console.log(element)
                });
                if(endloop){
                    if(skipStart)animArray.shift()

                    console.log(animArray)
                    animationqueue = setInterval(function(){
                        var delay = 0
                        var animNum = 0
                        spinewidget.state.clearTracks()
                        animArray.forEach(element => {
                            var curranim = element
                            var animTimes = 1
                            if(Array.isArray(element)){
                                curranim = element[0]
                                animTimes = element[1]
                            }
                            if(animNum==0)spinewidget.state.setAnimation(0,curranim,true)
                            else spinewidget.state.addAnimation(animNum,curranim,true,delay)
                            delay +=animations[GetAnimationIndex(animations,curranim)].duration*animTimes
                            animNum++
                            console.log(element)
                        });
                    },delay*1000)
                }
            }else{
                spinewidget.state.clearTracks()
                spinewidget.state.setAnimation(0,animArray,true)
            }
        }
        
        function CheckAnimationSet(anim){
            console.log(anim)
            if(anim.find(search=>search.name=="Interact")){
                //Build Mode
                console.log("Is Build")

            }else if(anim.find(search=>search.name=="Idle")){
                //Battle Mode
                console.log("Is Battle")
            }
        }

        function GetAnimationIndex(anim,name){
            return anim.map(function(e) { return e.name; }).indexOf(name)
        }
        function getUrlVars() {
            return new URL(window.location.href).searchParams;
        }
    </script>
</body>

</html>